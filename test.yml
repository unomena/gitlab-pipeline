---
- hosts: manager0
  any_errors_fatal: true
  remote_user: admin
  become: yes
  gather_facts: no
  vars:
    ansible_ssh_extra_args: "-o StrictHostKeyChecking=no"
    ansible_python_interpreter: /usr/bin/python3
    test_service: "$TEST_SERVICE"
    test_image: "$TEST_IMAGE-$CI_COMMIT_SHORT_SHA"
    test_command: "$TEST_COMMAND"

  tasks:
    - name: Resolve swarm node on which container is running for service in which test command should be run
      shell: "sleep 10 && docker service ps {{ resource_prefix }}_{{ test_service }} --filter 'desired-state=running' | grep {{ test_image }} | awk '{ n=split($4,a,\"-\"); print a[n] }'"
      register: node_res
      retries: 5
      delay: 1
      until: node_res.stdout_lines | list | count == 1

    - name: Execute test command in service container from relevant swarm node
      shell: "docker exec $(docker ps --filter name={{ resource_prefix }}_{{ test_service }} --format {{ '{{' }}.Names{{ '}}' }}) {{ test_command }}"
      delegate_to: "{{ node_res.stdout_lines[0] }}"
      register: test_command_result

    - debug:
        var: test_command_result.stdout_lines

    - debug:
        var: test_command_result.stderr_lines