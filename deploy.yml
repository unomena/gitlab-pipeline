---
- hosts: all
  remote_user: admin
  become: yes
  vars:
    ansible_ssh_extra_args: "-o StrictHostKeyChecking=no"
    ansible_python_interpreter: /usr/bin/python3
    ansible_ssh_private_key_file: keys/id_rsa

  tasks:
    - name: Add docker compose file
      copy:
        src: docker-compose.yml
        dest: /docker-compose.yml

    - name: Deploy docker stack
      shell: docker stack deploy --with-registry-auth -c /docker-compose.yml {{ resource_prefix }}
      environment:
        STAGE: "{{ stage }}"
        RESOURCE_PREFIX: "{{ resource_prefix }}"
        STACK_HOSTNAME: "{{ stack_hostname }}"
        CI_COMMIT_REF_SLUG: "{{ lookup('env', 'CI_COMMIT_REF_SLUG') }}"
        CI_PROJECT_REGISTRY: "{{ lookup('env', 'CI_PROJECT_REGISTRY') }}"

    - name: Remove docker compose file
      file:
        state: absent
        path: /docker-compose.yml